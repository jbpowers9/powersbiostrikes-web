<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biotech Catalyst Calendar | PowersBioStrikes</title>
    <meta name="description" content="Upcoming PDUFA dates, Phase 3 readouts, and biotech catalysts. Free 7-day preview, full calendar for members.">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark': '#1C1C1C',
                        'dark-card': '#242424',
                        'dark-border': '#333333',
                        'gold': '#D4AF37',
                        'gold-dark': '#8B6914',
                        'steel': '#5D6D7E',
                        'steel-light': '#85929E',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Calendar Grid Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #333;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        .calendar-header-cell {
            background: #2a2a2a;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
        }
        .calendar-day {
            background: #1f1f1f;
            min-height: 100px;
            padding: 8px;
            position: relative;
            transition: background 0.2s;
        }
        .calendar-day:hover {
            background: #252525;
        }
        .calendar-day.other-month {
            background: #1a1a1a;
        }
        .calendar-day.other-month .day-number {
            color: #444;
        }
        .calendar-day.today {
            background: rgba(212, 175, 55, 0.15);
        }
        .calendar-day.today .day-number {
            background: #D4AF37;
            color: #1C1C1C;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        /* Current week highlighting - brighter and more obvious */
        .calendar-day.current-week {
            background: rgba(212, 175, 55, 0.08);
            border-top: 2px solid rgba(212, 175, 55, 0.4);
            border-bottom: 2px solid rgba(212, 175, 55, 0.4);
        }
        .calendar-day.current-week .day-number {
            color: #D4AF37;
            font-weight: 600;
        }
        .calendar-day.current-week.week-start {
            border-left: 2px solid rgba(212, 175, 55, 0.4);
        }
        .calendar-day.current-week.week-end {
            border-right: 2px solid rgba(212, 175, 55, 0.4);
        }
        .day-number {
            font-size: 14px;
            color: #888;
            margin-bottom: 4px;
        }
        .catalyst-chip {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            margin-bottom: 2px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .catalyst-chip:hover {
            transform: scale(1.02);
        }
        .catalyst-chip.pdufa {
            background: rgba(255, 99, 71, 0.2);
            border-left: 2px solid #FF6B6B;
        }
        .catalyst-chip.phase3 {
            background: rgba(255, 165, 0, 0.2);
            border-left: 2px solid #FFA500;
        }
        .catalyst-chip.phase2 {
            background: rgba(100, 149, 237, 0.2);
            border-left: 2px solid #6495ED;
        }
        .catalyst-chip.adcom {
            background: rgba(255, 0, 255, 0.2);
            border-left: 2px solid #FF00FF;
        }
        .catalyst-chip.phase1 {
            background: rgba(76, 175, 80, 0.2);
            border-left: 2px solid #4CAF50;
        }
        .catalyst-chip.other {
            background: rgba(136, 136, 136, 0.2);
            border-left: 2px solid #888;
        }
        .catalyst-chip.initiation {
            background: rgba(0, 191, 255, 0.2);
            border-left: 2px solid #00BFFF;
        }
        .catalyst-chip.submission {
            background: rgba(147, 112, 219, 0.2);
            border-left: 2px solid #9370DB;
        }
        .catalyst-chip.big-mover {
            box-shadow: 0 0 8px rgba(255, 165, 0, 0.4);
        }
        /* Owned/Club positions - gold highlight */
        .catalyst-chip.owned {
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
            border: 1px solid #D4AF37 !important;
            background: rgba(212, 175, 55, 0.15) !important;
        }
        .catalyst-chip.owned .ticker {
            color: #D4AF37;
        }
        .catalyst-chip .ticker {
            font-weight: 700;
            color: #fff;
        }
        .catalyst-chip .type-abbr {
            font-size: 9px;
            opacity: 0.7;
        }
        .more-catalysts {
            font-size: 10px;
            color: #D4AF37;
            cursor: pointer;
            padding: 2px 4px;
        }
        .more-catalysts:hover {
            text-decoration: underline;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: #242424;
            border: 1px solid #444;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* Type badges */
        .type-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        .type-pdufa { background: rgba(255, 99, 71, 0.2); color: #FF6B6B; border: 1px solid rgba(255, 99, 71, 0.3); }
        .type-phase3 { background: rgba(255, 165, 0, 0.2); color: #FFA500; border: 1px solid rgba(255, 165, 0, 0.3); }
        .type-phase2 { background: rgba(100, 149, 237, 0.2); color: #6495ED; border: 1px solid rgba(100, 149, 237, 0.3); }
        .type-phase1 { background: rgba(76, 175, 80, 0.2); color: #4CAF50; border: 1px solid rgba(76, 175, 80, 0.3); }
        .type-adcom { background: rgba(255, 0, 255, 0.2); color: #FF00FF; border: 1px solid rgba(255, 0, 255, 0.3); }
        .type-other { background: rgba(136, 136, 136, 0.2); color: #888; border: 1px solid rgba(136, 136, 136, 0.3); }

        .designation-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        /* Risk colors */
        .risk-high { color: #FF6B6B; }
        .risk-medium-high { color: #FFA500; }
        .risk-medium { color: #FFD700; }
        .risk-low { color: #888; }

        /* Blur for non-members */
        .blur-content {
            filter: blur(5px);
            user-select: none;
            pointer-events: none;
        }

        /* List view styles */
        .list-view-card {
            background: linear-gradient(145deg, #2a2a2a 0%, #1f1f1f 100%);
            border: 1px solid #333;
            transition: all 0.3s ease;
        }
        .list-view-card:hover {
            border-color: #D4AF37;
        }

        /* View toggle */
        .view-toggle-btn {
            transition: all 0.2s;
        }
        .view-toggle-btn.active {
            background: #D4AF37;
            color: #1C1C1C;
        }
    </style>
</head>
<body class="bg-dark text-white min-h-screen">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-dark/95 backdrop-blur-sm border-b border-dark-border">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <a id="nav-logo-link" href="index.html" class="flex items-center gap-3">
                <svg class="h-10 w-10" viewBox="0 0 80 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="boltGradNav" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#D4AF37"/>
                            <stop offset="100%" style="stop-color:#8B6914"/>
                        </linearGradient>
                    </defs>
                    <path d="M45 5 L25 45 L38 45 L20 95 L55 40 L40 40 Z" fill="url(#boltGradNav)"/>
                    <circle cx="20" cy="95" r="6" fill="#D4AF37" opacity="0.9"/>
                    <circle cx="45" cy="5" r="5" fill="#8B6914" opacity="0.9"/>
                    <circle cx="55" cy="40" r="4" fill="#D4AF37" opacity="0.7"/>
                </svg>
                <span class="text-gold font-bold text-xl tracking-wider">PowersBioStrikes</span>
            </a>
            <div class="flex items-center space-x-6">
                <a id="nav-home-link" href="index.html" class="text-gray-300 hover:text-gold transition-colors">Home</a>
                <a id="nav-positions-link" href="positions.html" class="text-gray-300 hover:text-gold transition-colors">Positions</a>
                <a href="calendar.html" class="text-gold font-semibold">Calendar</a>
                <a id="nav-members-link" href="login.html" class="px-4 py-2 bg-gold text-dark rounded-lg font-semibold hover:bg-gold/90 transition-colors">Members</a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="pt-24 pb-6 px-4">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-6">
                <h1 class="text-4xl font-bold mb-3">
                    <span class="text-gold">Biotech Catalyst</span> Calendar
                </h1>
                <p id="calendar-description" class="text-gray-400 text-lg max-w-2xl mx-auto">
                    Upcoming PDUFA dates, Phase 2/3 readouts, and AdCom meetings.
                    <span id="member-promo" class="text-gold">Next 7 days free</span><span id="member-promo-suffix"> - full calendar for members.</span>
                </p>
            </div>

            <!-- Summary Stats -->
            <div id="summary-stats" class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-6">
                <!-- Populated by JS -->
            </div>
        </div>
    </section>

    <!-- Calendar Controls -->
    <section class="px-4 pb-4">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                <!-- Month Navigation -->
                <div class="flex items-center gap-4">
                    <button onclick="changeMonth(-1)" class="p-2 rounded-lg bg-dark-card border border-dark-border hover:border-gold transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h2 id="current-month" class="text-2xl font-bold min-w-[200px] text-center">January 2025</h2>
                    <button onclick="changeMonth(1)" class="p-2 rounded-lg bg-dark-card border border-dark-border hover:border-gold transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                    <button onclick="goToToday()" class="px-3 py-2 text-sm rounded-lg bg-dark-card border border-dark-border hover:border-gold transition-colors">
                        Today
                    </button>
                </div>

                <!-- View Toggle & Filters -->
                <div class="flex items-center gap-3">
                    <!-- View Toggle -->
                    <div class="flex rounded-lg overflow-hidden border border-dark-border">
                        <button onclick="setView('grid')" id="view-grid" class="view-toggle-btn active px-3 py-2 text-sm bg-dark-card">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                            </svg>
                        </button>
                        <button onclick="setView('list')" id="view-list" class="view-toggle-btn px-3 py-2 text-sm bg-dark-card">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Filter Dropdown -->
                    <select id="type-filter" onchange="filterCatalysts(this.value)" class="px-3 py-2 rounded-lg bg-dark-card border border-dark-border text-sm focus:border-gold outline-none">
                        <option value="all">All Events</option>
                        <option value="big-movers">Big Movers Only</option>
                        <option value="PDUFA">PDUFA</option>
                        <option value="AdCom">AdCom</option>
                        <option value="Phase 3">Phase 3</option>
                        <option value="Phase 2">Phase 2</option>
                        <option value="Phase 1">Phase 1</option>
                        <option value="Initiation">Initiations</option>
                        <option value="Submission">Submissions</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
        </div>
    </section>

    <!-- Calendar Content -->
    <section class="pb-16 px-4">
        <div class="max-w-7xl mx-auto">
            <!-- Grid View -->
            <div id="calendar-grid-container">
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Header row -->
                    <div class="calendar-header-cell">Sun</div>
                    <div class="calendar-header-cell">Mon</div>
                    <div class="calendar-header-cell">Tue</div>
                    <div class="calendar-header-cell">Wed</div>
                    <div class="calendar-header-cell">Thu</div>
                    <div class="calendar-header-cell">Fri</div>
                    <div class="calendar-header-cell">Sat</div>
                    <!-- Days populated by JS -->
                </div>
            </div>

            <!-- List View (hidden by default) -->
            <div id="list-view-container" class="hidden">
                <div id="list-view" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Upcoming Club Catalysts Section (Members Only) -->
            <div id="club-catalysts-section" class="hidden mt-10">
                <div class="border-t border-dark-border pt-8">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-gold">âš¡</span>
                        Upcoming Club Catalysts
                        <span class="text-sm font-normal text-gray-500 ml-2">Positions we're watching</span>
                    </h3>
                    <div id="club-catalysts-grid" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Members Gate (for non-members viewing beyond 7 days) -->
            <div id="members-gate" class="hidden mt-8 text-center p-8 bg-dark-card border border-gold/30 rounded-xl max-w-md mx-auto">
                <div class="text-4xl mb-4">ðŸ”’</div>
                <h3 class="text-xl font-bold text-gold mb-2">Members Only</h3>
                <p class="text-gray-400 mb-4">
                    Get access to the full catalyst calendar with all upcoming events and detailed analysis.
                </p>
                <a href="index.html#founding" class="inline-block px-6 py-3 bg-gold text-dark font-bold rounded-lg hover:bg-gold/90 transition-colors">
                    Become a Founding Member
                </a>
                <p class="text-sm text-gray-500 mt-3">Free for 6 months - limited spots</p>
            </div>
        </div>
    </section>

    <!-- CTA Section (hidden for members) -->
    <section id="cta-section" class="py-16 px-4 bg-dark-card border-t border-dark-border">
        <div class="max-w-4xl mx-auto text-center">
            <h2 class="text-3xl font-bold mb-4">Want the Full Calendar + Trade Alerts?</h2>
            <p class="text-gray-400 mb-6">
                Founding members get 6 months free access to all catalysts, CONT scores, and live trade alerts.
            </p>
            <a href="index.html#founding" class="inline-block px-8 py-4 bg-gold text-dark font-bold rounded-lg text-lg hover:bg-gold/90 transition-colors">
                Join Founding Members
            </a>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-8 px-4 border-t border-dark-border">
        <div class="max-w-7xl mx-auto text-center text-gray-500 text-sm">
            <p>Catalyst dates are sourced from public FDA filings and ClinicalTrials.gov.</p>
            <p class="mt-2">&copy; 2025 PowersBioStrikes. Not financial advice.</p>
        </div>
    </footer>

    <!-- Day List Modal (for "+X more" clicks) -->
    <div id="day-modal" class="modal-overlay" onclick="closeDayModal(event)">
        <div class="modal-content p-6" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="day-modal-title" class="text-xl font-bold text-gold"></h3>
                    <p id="day-modal-count" class="text-gray-500 text-sm"></p>
                </div>
                <button onclick="closeDayModal()" class="text-gray-500 hover:text-white p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="day-modal-list" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Catalyst Detail Modal -->
    <div id="catalyst-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content p-6" onclick="event.stopPropagation()" style="max-width: 500px;">
            <!-- Header -->
            <div class="flex justify-between items-start mb-4">
                <div>
                    <div class="flex items-center gap-3 mb-1">
                        <span id="modal-ticker" class="text-3xl font-bold"></span>
                        <span id="modal-type-badge" class="type-badge"></span>
                        <span id="modal-big-mover" class="hidden px-2 py-1 text-xs font-bold bg-orange-500/20 text-orange-400 rounded">BIG MOVER</span>
                    </div>
                    <div id="modal-company-name" class="text-gray-500 text-sm"></div>
                    <div id="modal-date" class="text-gray-400 mt-1"></div>
                </div>
                <button onclick="closeModal()" class="text-gray-500 hover:text-white p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4 text-sm">
                <!-- Drug & Indication -->
                <div class="bg-dark-card rounded-lg p-3">
                    <div id="modal-drug" class="text-gold font-semibold"></div>
                    <div id="modal-indication" class="text-gray-400 text-xs mt-1"></div>
                    <div id="modal-category" class="text-gray-500 text-xs mt-1"></div>
                </div>

                <!-- Designations -->
                <div id="modal-designations" class="flex flex-wrap gap-1"></div>

                <!-- Movement Potential (if available) -->
                <div id="modal-movement-section" class="bg-dark-card rounded-lg p-3 hidden">
                    <div class="text-gray-500 text-xs mb-2">MOVEMENT POTENTIAL</div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <div id="modal-success-prob" class="text-lg font-bold text-green-400">-</div>
                            <div class="text-gray-500 text-xs">Success</div>
                        </div>
                        <div>
                            <div id="modal-upside" class="text-lg font-bold text-green-400">-</div>
                            <div class="text-gray-500 text-xs">Upside</div>
                        </div>
                        <div>
                            <div id="modal-downside" class="text-lg font-bold text-red-400">-</div>
                            <div class="text-gray-500 text-xs">Downside</div>
                        </div>
                    </div>
                </div>

                <!-- Risk Assessment -->
                <div class="bg-dark-card rounded-lg p-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-gray-500 text-xs">RISK LEVEL</span>
                            <div class="flex items-center gap-2 mt-1">
                                <span id="modal-risk" class="font-semibold"></span>
                            </div>
                        </div>
                        <div id="modal-crl-warning" class="hidden text-right">
                            <span class="text-red-400 text-xs font-bold">CRL HISTORY</span>
                            <div id="modal-crl-count" class="text-red-400 text-xs"></div>
                        </div>
                    </div>
                    <div id="modal-risk-note" class="text-xs text-gray-500 mt-1"></div>
                </div>

                <!-- Company Stats -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-dark-card rounded-lg p-3 text-center">
                        <div id="modal-mcap" class="text-lg font-bold text-white">-</div>
                        <div class="text-gray-500 text-xs">Market Cap</div>
                    </div>
                    <div class="bg-dark-card rounded-lg p-3 text-center">
                        <div id="modal-short" class="text-lg font-bold text-white">-</div>
                        <div class="text-gray-500 text-xs">Short Interest</div>
                    </div>
                </div>

                <!-- Members-Only Analysis Section -->
                <div id="modal-analysis-section" class="bg-gradient-to-r from-gold/10 to-transparent rounded-lg p-3 hidden">
                    <div class="text-gold text-xs mb-2 font-semibold">MEMBERS ANALYSIS</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <span class="text-gray-500 text-xs">CONT Score</span>
                            <div id="modal-cont-score" class="font-bold text-white">-</div>
                        </div>
                        <div>
                            <span class="text-gray-500 text-xs">Play Type</span>
                            <div id="modal-play-type" class="font-bold text-white">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK for auth check -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        let calendarData = null;
        let currentFilter = 'all';
        let currentView = 'grid';
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let isUserAuthenticated = false;
        let ownedPositions = {}; // ticker -> position data

        // Load owned positions from positions.json
        async function loadOwnedPositions() {
            try {
                const response = await fetch('data/positions.json');
                const data = await response.json();
                ownedPositions = {};
                (data.positions || []).forEach(pos => {
                    if (pos.status === 'OPEN') {
                        ownedPositions[pos.ticker] = pos;
                    }
                });
                console.log('[Calendar] Loaded owned positions:', Object.keys(ownedPositions));
            } catch (e) {
                console.log('[Calendar] Could not load positions.json:', e.message);
            }
        }

        // Check if a ticker is owned
        function isOwnedTicker(ticker) {
            return !!ownedPositions[ticker];
        }

        // Update navigation for logged-in members
        async function updateNavForMember() {
            try {
                const user = await pbsAuth.getUser();
                if (user) {
                    const logoLink = document.getElementById('nav-logo-link');
                    if (logoLink) logoLink.href = 'dashboard.html';

                    const homeLink = document.getElementById('nav-home-link');
                    if (homeLink) {
                        homeLink.href = 'dashboard.html';
                        homeLink.textContent = 'â† Dashboard';
                    }

                    const positionsLink = document.getElementById('nav-positions-link');
                    if (positionsLink) positionsLink.classList.add('hidden');

                    const membersLink = document.getElementById('nav-members-link');
                    if (membersLink) membersLink.classList.add('hidden');
                }
            } catch (err) {}
        }

        document.addEventListener('DOMContentLoaded', updateNavForMember);

        // Check authentication
        async function checkAuth() {
            try {
                const user = await pbsAuth.getUser();
                isUserAuthenticated = !!user;

                if (isUserAuthenticated) {
                    // Hide non-member promotional elements
                    document.getElementById('member-promo')?.classList.add('hidden');
                    document.getElementById('member-promo-suffix')?.classList.add('hidden');
                    document.getElementById('cta-section')?.classList.add('hidden');
                    document.getElementById('members-gate')?.classList.add('hidden');
                }
            } catch (e) {
                isUserAuthenticated = false;
            }
        }

        // Feature flag: Use Supabase or static JSON
        // Set to true once Supabase table is populated
        const USE_SUPABASE = true;

        // Load calendar data
        async function loadCalendar() {
            try {
                if (USE_SUPABASE && window.pbsCatalysts) {
                    // Load from Supabase
                    const [catalystsResult, summaryResult] = await Promise.all([
                        isUserAuthenticated ? pbsCatalysts.getAllCatalysts() : pbsCatalysts.getPublicCatalysts(),
                        pbsCatalysts.getSummary()
                    ]);

                    if (catalystsResult.error) throw catalystsResult.error;

                    // Transform Supabase data to match static JSON format
                    calendarData = {
                        summary: {
                            total_catalysts: summaryResult.data?.total || 0,
                            this_week: summaryResult.data?.this_week || 0,
                            next_week: summaryResult.data?.next_week || 0,
                            this_month: summaryResult.data?.this_month || 0,
                            big_movers: summaryResult.data?.big_movers || 0,
                            by_type: summaryResult.data?.by_type || {}
                        },
                        catalysts: (catalystsResult.data || []).map(c => ({
                            ticker: c.ticker,
                            date: c.catalyst_date,
                            date_display: c.date_display,
                            weekday: c.weekday?.trim(),
                            days_until: c.days_until,
                            is_public: c.is_public,
                            event: {
                                type: c.event_type,
                                stage: c.stage,
                                description: c.catalyst_event,
                                drug_name: c.drug_name,
                                indication: c.indication,
                                is_binary: c.is_binary,
                                is_milestone: c.is_milestone,
                            },
                            company: {
                                name: c.company_name,
                                mcap_millions: c.mcap_millions,
                                short_interest_pct: c.short_interest_pct,
                            },
                            movement: {
                                is_big_mover: c.is_big_mover,
                                mover_score: c.mover_score,
                                success_prob: c.success_prob,
                                upside_pct: c.upside_pct,
                                downside_pct: c.downside_pct,
                            },
                            risk_factors: {
                                has_crl_history: c.has_crl_history,
                                crl_count: c.crl_count,
                            },
                            analysis: {
                                cont_score: c.cont_score,
                                cont_rating: c.cont_rating,
                            },
                            meta: {
                                is_phase1: c.is_phase1,
                                is_initiation: c.is_initiation,
                                is_submission: c.is_submission,
                            }
                        }))
                    };
                    console.log('[Calendar] Loaded from Supabase:', calendarData.catalysts.length, 'catalysts');
                } else {
                    // Load from static JSON
                    const response = await fetch('data/calendar.json');
                    calendarData = await response.json();
                    console.log('[Calendar] Loaded from static JSON:', calendarData.catalysts.length, 'catalysts');
                }
                renderSummary();
                renderCalendar();
            } catch (error) {
                console.error('Failed to load calendar:', error);
                // Fallback to static JSON if Supabase fails
                if (USE_SUPABASE) {
                    console.log('[Calendar] Supabase failed, falling back to static JSON');
                    const response = await fetch('data/calendar.json');
                    calendarData = await response.json();
                    renderSummary();
                    renderCalendar();
                }
            }
        }

        // Render summary stats
        function renderSummary() {
            const summary = calendarData.summary;
            document.getElementById('summary-stats').innerHTML = `
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-gold">${summary.total_catalysts}</div>
                    <div class="text-gray-500 text-xs">Total</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-400">${summary.this_week}</div>
                    <div class="text-gray-500 text-xs">This Week</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-red-400">${summary.by_type.PDUFA || 0}</div>
                    <div class="text-gray-500 text-xs">PDUFA</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-orange-400">${summary.by_type['Phase 3'] || 0}</div>
                    <div class="text-gray-500 text-xs">Phase 3</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-blue-400">${summary.by_type['Phase 2'] || 0}</div>
                    <div class="text-gray-500 text-xs">Phase 2</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold" style="color: #4CAF50">${summary.by_type['Phase 1'] || 0}</div>
                    <div class="text-gray-500 text-xs">Phase 1</div>
                </div>
            `;
        }

        // Get catalysts for a specific date (owned positions sorted first)
        function getCatalystsForDate(year, month, day) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const catalysts = calendarData.catalysts.filter(c => {
                if (currentFilter === 'big-movers' && !c.movement?.is_big_mover) return false;
                if (currentFilter !== 'all' && currentFilter !== 'big-movers' && c.event.type !== currentFilter) return false;
                return c.date === dateStr;
            });
            // Sort owned positions first
            return catalysts.sort((a, b) => {
                const aOwned = isOwnedTicker(a.ticker) ? 0 : 1;
                const bOwned = isOwnedTicker(b.ticker) ? 0 : 1;
                return aOwned - bOwned;
            });
        }

        // Check if date is within free preview period (7 days)
        function isWithinFreePreview(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(dateStr);
            const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            return diffDays <= 7 && diffDays >= 0;
        }

        // Get type class for chip
        function getTypeClass(type) {
            const typeMap = {
                'PDUFA': 'pdufa',
                'Phase 3': 'phase3',
                'Phase 2': 'phase2',
                'Phase 1': 'phase1',
                'AdCom': 'adcom',
                'Initiation': 'initiation',
                'Submission': 'submission'
            };
            return typeMap[type] || 'other';
        }

        // Check if a date is in the current week
        function isInCurrentWeek(year, month, day) {
            const today = new Date();
            const checkDate = new Date(year, month, day);

            // Get start of current week (Sunday)
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            weekStart.setHours(0, 0, 0, 0);

            // Get end of current week (Saturday)
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);

            return checkDate >= weekStart && checkDate <= weekEnd;
        }

        // Get day of week (0=Sunday, 6=Saturday)
        function getDayOfWeek(year, month, day) {
            return new Date(year, month, day).getDay();
        }

        // Render calendar grid
        function renderCalendar() {
            if (currentView === 'grid') {
                renderGridView();
            } else {
                renderListView();
            }
        }

        // Render grid view
        function renderGridView() {
            document.getElementById('calendar-grid-container').classList.remove('hidden');
            document.getElementById('list-view-container').classList.add('hidden');

            // Update month title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Get first day of month and total days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

            const today = new Date();
            const isCurrentMonth = today.getFullYear() === currentYear && today.getMonth() === currentMonth;

            // Build calendar grid
            const grid = document.getElementById('calendar-grid');

            // Keep header cells, remove day cells
            const headerCells = Array.from(grid.querySelectorAll('.calendar-header-cell'));
            grid.innerHTML = '';
            headerCells.forEach(cell => grid.appendChild(cell));

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                grid.appendChild(createDayCell(prevYear, prevMonth, day, true));
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = isCurrentMonth && today.getDate() === day;
                grid.appendChild(createDayCell(currentYear, currentMonth, day, false, isToday));
            }

            // Next month days to complete the grid
            const totalCells = firstDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let day = 1; day <= remainingCells; day++) {
                const nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
                const nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;
                grid.appendChild(createDayCell(nextYear, nextMonth, day, true));
            }
        }

        // Create a day cell
        function createDayCell(year, month, day, isOtherMonth, isToday = false) {
            const cell = document.createElement('div');
            let className = 'calendar-day';
            if (isOtherMonth) className += ' other-month';
            if (isToday) className += ' today';

            // Add current week highlighting
            if (!isOtherMonth && isInCurrentWeek(year, month, day)) {
                className += ' current-week';
                const dayOfWeek = getDayOfWeek(year, month, day);
                if (dayOfWeek === 0) className += ' week-start';
                if (dayOfWeek === 6) className += ' week-end';
            }

            cell.className = className;

            const dayNum = document.createElement('div');
            dayNum.className = 'day-number';
            dayNum.textContent = day;
            cell.appendChild(dayNum);

            // Get catalysts for this day
            const catalysts = getCatalystsForDate(year, month, day);
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isPreview = isWithinFreePreview(dateStr);
            const canView = isUserAuthenticated || isPreview;

            // Show up to 3 catalysts, then "more" link
            const maxShow = 3;
            catalysts.slice(0, maxShow).forEach(cat => {
                const chip = document.createElement('div');
                const isBigMover = cat.movement?.is_big_mover;
                const isOwned = isOwnedTicker(cat.ticker);
                chip.className = `catalyst-chip ${getTypeClass(cat.event.type)}${isBigMover ? ' big-mover' : ''}${isOwned ? ' owned' : ''}` + (!canView ? ' blur-content' : '');
                const typeAbbr = {'Phase 3': 'P3', 'Phase 2': 'P2', 'Phase 1': 'P1', 'Initiation': 'INIT', 'Submission': 'SUB'}[cat.event.type] || cat.event.type;
                chip.innerHTML = `
                    ${isOwned ? '<span style="color: #D4AF37;">âš¡</span>' : (isBigMover ? '<span style="color: #FFA500;">â˜…</span>' : '')}
                    <span class="ticker">${cat.ticker}</span>
                    <span class="type-abbr">${typeAbbr}</span>
                `;
                if (canView) {
                    chip.onclick = () => openModal(cat);
                }
                cell.appendChild(chip);
            });

            if (catalysts.length > maxShow) {
                const more = document.createElement('div');
                more.className = 'more-catalysts' + (!canView ? ' blur-content' : '');
                more.textContent = `+${catalysts.length - maxShow} more`;
                if (canView) {
                    more.onclick = () => showDayModal(year, month, day, catalysts);
                }
                cell.appendChild(more);
            }

            return cell;
        }

        // Render list view
        function renderListView() {
            document.getElementById('calendar-grid-container').classList.add('hidden');
            document.getElementById('list-view-container').classList.remove('hidden');

            const listView = document.getElementById('list-view');

            // Filter catalysts for current month
            const catalysts = calendarData.catalysts.filter(c => {
                if (currentFilter === 'big-movers' && !c.movement?.is_big_mover) return false;
                if (currentFilter !== 'all' && currentFilter !== 'big-movers' && c.event.type !== currentFilter) return false;
                const date = new Date(c.date);
                return date.getFullYear() === currentYear && date.getMonth() === currentMonth;
            });

            if (catalysts.length === 0) {
                listView.innerHTML = '<p class="text-gray-500 text-center py-8">No catalysts this month.</p>';
                return;
            }

            listView.innerHTML = catalysts.map(cat => {
                const canView = isUserAuthenticated || isWithinFreePreview(cat.date);
                const typeClass = `type-${cat.event.type.toLowerCase().replace(' ', '')}`;
                const riskClass = `risk-${cat.risk.level.toLowerCase().replace('-', '')}`;

                const designationBadges = cat.designations.map(d =>
                    `<span class="designation-badge" style="background: ${d.color}20; color: ${d.color}; border: 1px solid ${d.color}40">${d.code}</span>`
                ).join('');

                return `
                    <div class="list-view-card rounded-lg p-4 ${!canView ? 'blur-content' : ''}" ${canView ? `onclick="openModal(calendarData.catalysts.find(c => c.ticker === '${cat.ticker}' && c.date === '${cat.date}'))"` : ''} style="cursor: ${canView ? 'pointer' : 'default'}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-3">
                                <span class="text-xl font-bold">${cat.ticker}</span>
                                <span class="type-badge ${typeClass}">${cat.event.type}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold">${cat.date_display}</div>
                                <div class="text-gray-500 text-sm">${cat.weekday}</div>
                            </div>
                        </div>
                        <div class="text-gold text-sm">${cat.event.drug_name || ''}</div>
                        <div class="text-gray-500 text-sm">${cat.event.indication || cat.event.description || ''}</div>
                        ${designationBadges ? `<div class="flex flex-wrap gap-1 mt-2">${designationBadges}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Open modal with catalyst details
        function openModal(catalyst) {
            console.log('openModal called with:', catalyst?.ticker);

            const modal = document.getElementById('catalyst-modal');
            if (!modal) {
                console.error('Modal element not found');
                alert('Modal not found!');
                return;
            }
            if (!catalyst) {
                console.error('No catalyst data');
                alert('No catalyst data!');
                return;
            }

            const typeClass = `type-${(catalyst.event?.type || 'other').toLowerCase().replace(' ', '')}`;
            const riskLevel = catalyst.risk?.level || 'LOW';
            const riskClass = `risk-${riskLevel.toLowerCase().replace('-', '')}`;

            // Header
            document.getElementById('modal-ticker').textContent = catalyst.ticker || 'N/A';
            document.getElementById('modal-type-badge').className = `type-badge ${typeClass}`;
            document.getElementById('modal-type-badge').textContent = catalyst.event?.type || 'Unknown';
            document.getElementById('modal-date').textContent = `${catalyst.date_display || ''} (${catalyst.weekday || ''}) â€¢ ${catalyst.days_until || 0} days`;
            document.getElementById('modal-company-name').textContent = catalyst.company?.name || '';

            // Big mover badge
            const bigMoverBadge = document.getElementById('modal-big-mover');
            if (bigMoverBadge) {
                bigMoverBadge.classList.toggle('hidden', !catalyst.movement?.is_big_mover);
            }

            // Drug & Indication
            document.getElementById('modal-drug').textContent = catalyst.event?.drug_name || 'Drug name not available';
            document.getElementById('modal-indication').textContent = catalyst.event?.indication || '';
            document.getElementById('modal-category').textContent = catalyst.event?.category ? `Category: ${catalyst.event.category}` : '';

            // Designations
            const designations = catalyst.designations || [];
            const designationsHtml = designations.map(d =>
                `<span class="px-2 py-0.5 text-xs rounded" style="background: ${d.color}20; color: ${d.color}; border: 1px solid ${d.color}40">${d.code}</span>`
            ).join('');
            document.getElementById('modal-designations').innerHTML = designationsHtml;

            // Movement Potential
            const movementSection = document.getElementById('modal-movement-section');
            if (movementSection) {
                const hasMovementData = catalyst.movement?.success_prob || catalyst.movement?.upside_pct;
                movementSection.classList.toggle('hidden', !hasMovementData);
                if (hasMovementData) {
                    const successEl = document.getElementById('modal-success-prob');
                    const upsideEl = document.getElementById('modal-upside');
                    const downsideEl = document.getElementById('modal-downside');
                    if (successEl) successEl.textContent = catalyst.movement?.success_prob ? `${Math.round(catalyst.movement.success_prob)}%` : '-';
                    if (upsideEl) upsideEl.textContent = catalyst.movement?.upside_pct ? `+${Math.round(catalyst.movement.upside_pct)}%` : '-';
                    if (downsideEl) downsideEl.textContent = catalyst.movement?.downside_pct ? `-${Math.round(catalyst.movement.downside_pct)}%` : '-';
                }
            }

            // Risk
            document.getElementById('modal-risk').textContent = riskLevel;
            document.getElementById('modal-risk').className = riskClass + ' font-semibold';
            document.getElementById('modal-risk-note').textContent = catalyst.risk?.note || '';

            // CRL Warning
            const crlWarning = document.getElementById('modal-crl-warning');
            if (crlWarning) {
                crlWarning.classList.toggle('hidden', !catalyst.risk_factors?.has_crl_history);
                if (catalyst.risk_factors?.has_crl_history) {
                    const crlCountEl = document.getElementById('modal-crl-count');
                    if (crlCountEl) crlCountEl.textContent = `${catalyst.risk_factors.crl_count || 0} prior rejection(s)`;
                }
            }

            // Company info
            const mcap = catalyst.company?.mcap_millions;
            const shortInt = catalyst.company?.short_interest_pct;
            document.getElementById('modal-mcap').textContent = mcap ? `$${Math.round(mcap)}M` : '-';
            document.getElementById('modal-short').textContent = shortInt ? `${shortInt.toFixed(1)}%` : '-';

            // Members-only analysis
            const analysisSection = document.getElementById('modal-analysis-section');
            if (analysisSection) {
                const hasAnalysis = isUserAuthenticated && (catalyst.analysis?.cont_score || catalyst.analysis?.play_type);
                analysisSection.classList.toggle('hidden', !hasAnalysis);
                if (hasAnalysis) {
                    const contEl = document.getElementById('modal-cont-score');
                    const playEl = document.getElementById('modal-play-type');
                    if (contEl) contEl.textContent = catalyst.analysis?.cont_score || '-';
                    if (playEl) playEl.textContent = catalyst.analysis?.play_type || '-';
                }
            }

            modal.classList.add('active');
            console.log('Modal should now be visible');
        }

        // Close modal
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('catalyst-modal').classList.remove('active');
        }

        // Show all catalysts for a day (when clicking "+more")
        function showDayModal(year, month, day, catalysts) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];

            document.getElementById('day-modal-title').textContent = `${monthNames[month]} ${day}, ${year}`;
            document.getElementById('day-modal-count').textContent = `${catalysts.length} catalysts`;

            const listHtml = catalysts.map(cat => {
                const typeClass = getTypeClass(cat.event.type);
                const isOwned = isOwnedTicker(cat.ticker);
                const isBigMover = cat.movement?.is_big_mover;
                const typeAbbr = {'Phase 3': 'P3', 'Phase 2': 'P2', 'Phase 1': 'P1', 'Initiation': 'INIT', 'Submission': 'SUB'}[cat.event.type] || cat.event.type;

                return `
                    <div class="catalyst-chip ${typeClass}${isBigMover ? ' big-mover' : ''}${isOwned ? ' owned' : ''}"
                         style="padding: 8px 12px; cursor: pointer;"
                         onclick="closeDayModal(); openModal(calendarData.catalysts.find(c => c.ticker === '${cat.ticker}' && c.date === '${cat.date}'))">
                        <div class="flex items-center gap-2 w-full">
                            ${isOwned ? '<span style="color: #D4AF37;">âš¡</span>' : (isBigMover ? '<span style="color: #FFA500;">â˜…</span>' : '')}
                            <span class="ticker text-base">${cat.ticker}</span>
                            <span class="type-abbr">${typeAbbr}</span>
                            <span class="text-gray-400 text-xs ml-auto">${cat.event.drug_name || cat.event.description || ''}</span>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('day-modal-list').innerHTML = listHtml;
            document.getElementById('day-modal').classList.add('active');
        }

        // Close day modal
        function closeDayModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('day-modal').classList.remove('active');
        }

        // Change month
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        // Go to today
        function goToToday() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            renderCalendar();
        }

        // Set view (grid/list)
        function setView(view) {
            currentView = view;
            document.getElementById('view-grid').classList.toggle('active', view === 'grid');
            document.getElementById('view-list').classList.toggle('active', view === 'list');
            renderCalendar();
        }

        // Filter catalysts
        function filterCatalysts(filter) {
            currentFilter = filter;
            document.getElementById('type-filter').value = filter;
            renderCalendar();
        }

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeDayModal();
            }
        });

        // Render Upcoming Club Catalysts section (members only)
        function renderClubCatalysts() {
            const section = document.getElementById('club-catalysts-section');
            const grid = document.getElementById('club-catalysts-grid');

            if (!isUserAuthenticated || !calendarData || Object.keys(ownedPositions).length === 0) {
                section.classList.add('hidden');
                return;
            }

            // Get upcoming catalysts for owned positions
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const upcomingClubCatalysts = [];
            Object.entries(ownedPositions).forEach(([ticker, pos]) => {
                if (pos.catalyst && pos.catalyst.date) {
                    const catalystDate = new Date(pos.catalyst.date);
                    const daysUntil = Math.ceil((catalystDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil >= -7) { // Show catalysts from past week through future
                        upcomingClubCatalysts.push({
                            ticker,
                            date: pos.catalyst.date,
                            dateDisplay: pos.catalyst.date_display,
                            event: pos.catalyst.event,
                            drug: pos.catalyst.drug,
                            daysUntil,
                            recommendation: pos.recommendation,
                            cont: pos.cont,
                            position: pos.position
                        });
                    }
                }
            });

            // Sort by date (soonest first)
            upcomingClubCatalysts.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (upcomingClubCatalysts.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            grid.innerHTML = upcomingClubCatalysts.map(cat => {
                const actionColor = {
                    'ACCUMULATE': 'text-green-400',
                    'HOLD': 'text-yellow-400',
                    'EXIT': 'text-red-400',
                    'WATCH': 'text-blue-400'
                }[cat.recommendation?.action] || 'text-gray-400';

                const daysLabel = cat.daysUntil === 0 ? 'TODAY' :
                                  cat.daysUntil < 0 ? `${Math.abs(cat.daysUntil)}d ago` :
                                  `${cat.daysUntil}d`;
                const daysColor = cat.daysUntil <= 0 ? 'text-red-400' :
                                  cat.daysUntil <= 7 ? 'text-yellow-400' :
                                  'text-gray-400';

                return `
                    <div class="bg-dark-card border border-gold/30 rounded-lg p-4 hover:border-gold/60 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-gold">âš¡</span>
                                <span class="text-xl font-bold text-gold">${cat.ticker}</span>
                            </div>
                            <div class="text-right">
                                <div class="${daysColor} font-bold text-sm">${daysLabel}</div>
                                <div class="text-gray-500 text-xs">${cat.dateDisplay || cat.date}</div>
                            </div>
                        </div>
                        <div class="text-sm text-white mb-1">${cat.event}</div>
                        ${cat.drug ? `<div class="text-xs text-gray-400 mb-2 line-clamp-2">${cat.drug}</div>` : ''}
                        <div class="flex justify-between items-center mt-3 pt-2 border-t border-dark-border">
                            <div>
                                <span class="text-xs text-gray-500">Action:</span>
                                <span class="${actionColor} text-sm font-semibold ml-1">${cat.recommendation?.action || '-'}</span>
                            </div>
                            ${cat.cont ? `
                            <div>
                                <span class="text-xs text-gray-500">CONT:</span>
                                <span class="text-sm font-semibold ml-1 ${cat.cont.rating === 'HIGH' ? 'text-green-400' : cat.cont.rating === 'MODERATE' ? 'text-yellow-400' : 'text-red-400'}">${cat.cont.score}</span>
                            </div>
                            ` : ''}
                        </div>
                        ${cat.recommendation?.notes ? `
                        <div class="mt-2 text-xs text-gray-500 line-clamp-2 italic">"${cat.recommendation.notes.substring(0, 100)}${cat.recommendation.notes.length > 100 ? '...' : ''}"</div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Initialize
        async function init() {
            await checkAuth();
            await loadOwnedPositions();
            await loadCalendar();
            renderClubCatalysts();
        }
        init();
    </script>
</body>
</html>
