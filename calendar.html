<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biotech Catalyst Calendar | PowersBioStrikes</title>
    <meta name="description" content="Upcoming PDUFA dates, Phase 3 readouts, and biotech catalysts. Free 7-day preview, full calendar for members.">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark': '#1C1C1C',
                        'dark-card': '#242424',
                        'dark-border': '#333333',
                        'gold': '#D4AF37',
                        'gold-dark': '#8B6914',
                        'steel': '#5D6D7E',
                        'steel-light': '#85929E',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Calendar Grid Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #333;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        .calendar-header-cell {
            background: #2a2a2a;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
        }
        .calendar-day {
            background: #1f1f1f;
            min-height: 100px;
            padding: 8px;
            position: relative;
            transition: background 0.2s;
        }
        .calendar-day:hover {
            background: #252525;
        }
        .calendar-day.other-month {
            background: #1a1a1a;
        }
        .calendar-day.other-month .day-number {
            color: #444;
        }
        .calendar-day.today {
            background: rgba(212, 175, 55, 0.15);
        }
        .calendar-day.today .day-number {
            background: #D4AF37;
            color: #1C1C1C;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        /* Current week highlighting - brighter and more obvious */
        .calendar-day.current-week {
            background: rgba(212, 175, 55, 0.08);
            border-top: 2px solid rgba(212, 175, 55, 0.4);
            border-bottom: 2px solid rgba(212, 175, 55, 0.4);
        }
        .calendar-day.current-week .day-number {
            color: #D4AF37;
            font-weight: 600;
        }
        .calendar-day.current-week.week-start {
            border-left: 2px solid rgba(212, 175, 55, 0.4);
        }
        .calendar-day.current-week.week-end {
            border-right: 2px solid rgba(212, 175, 55, 0.4);
        }
        .day-number {
            font-size: 14px;
            color: #888;
            margin-bottom: 4px;
        }
        .catalyst-chip {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            margin-bottom: 2px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .catalyst-chip:hover {
            transform: scale(1.02);
        }
        .catalyst-chip.pdufa {
            background: rgba(255, 99, 71, 0.2);
            border-left: 2px solid #FF6B6B;
        }
        .catalyst-chip.phase3 {
            background: rgba(255, 165, 0, 0.2);
            border-left: 2px solid #FFA500;
        }
        .catalyst-chip.phase2 {
            background: rgba(100, 149, 237, 0.2);
            border-left: 2px solid #6495ED;
        }
        .catalyst-chip.adcom {
            background: rgba(255, 0, 255, 0.2);
            border-left: 2px solid #FF00FF;
        }
        .catalyst-chip.phase1 {
            background: rgba(76, 175, 80, 0.2);
            border-left: 2px solid #4CAF50;
        }
        .catalyst-chip.other {
            background: rgba(136, 136, 136, 0.2);
            border-left: 2px solid #888;
        }
        .catalyst-chip.initiation {
            background: rgba(0, 191, 255, 0.2);
            border-left: 2px solid #00BFFF;
        }
        .catalyst-chip.submission {
            background: rgba(147, 112, 219, 0.2);
            border-left: 2px solid #9370DB;
        }
        .catalyst-chip.big-mover {
            box-shadow: 0 0 8px rgba(255, 165, 0, 0.4);
        }
        .catalyst-chip .ticker {
            font-weight: 700;
            color: #fff;
        }
        .catalyst-chip .type-abbr {
            font-size: 9px;
            opacity: 0.7;
        }
        .more-catalysts {
            font-size: 10px;
            color: #D4AF37;
            cursor: pointer;
            padding: 2px 4px;
        }
        .more-catalysts:hover {
            text-decoration: underline;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: #242424;
            border: 1px solid #444;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* Type badges */
        .type-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        .type-pdufa { background: rgba(255, 99, 71, 0.2); color: #FF6B6B; border: 1px solid rgba(255, 99, 71, 0.3); }
        .type-phase3 { background: rgba(255, 165, 0, 0.2); color: #FFA500; border: 1px solid rgba(255, 165, 0, 0.3); }
        .type-phase2 { background: rgba(100, 149, 237, 0.2); color: #6495ED; border: 1px solid rgba(100, 149, 237, 0.3); }
        .type-phase1 { background: rgba(76, 175, 80, 0.2); color: #4CAF50; border: 1px solid rgba(76, 175, 80, 0.3); }
        .type-adcom { background: rgba(255, 0, 255, 0.2); color: #FF00FF; border: 1px solid rgba(255, 0, 255, 0.3); }
        .type-other { background: rgba(136, 136, 136, 0.2); color: #888; border: 1px solid rgba(136, 136, 136, 0.3); }

        .designation-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        /* Risk colors */
        .risk-high { color: #FF6B6B; }
        .risk-medium-high { color: #FFA500; }
        .risk-medium { color: #FFD700; }
        .risk-low { color: #888; }

        /* Blur for non-members */
        .blur-content {
            filter: blur(5px);
            user-select: none;
            pointer-events: none;
        }

        /* List view styles */
        .list-view-card {
            background: linear-gradient(145deg, #2a2a2a 0%, #1f1f1f 100%);
            border: 1px solid #333;
            transition: all 0.3s ease;
        }
        .list-view-card:hover {
            border-color: #D4AF37;
        }

        /* View toggle */
        .view-toggle-btn {
            transition: all 0.2s;
        }
        .view-toggle-btn.active {
            background: #D4AF37;
            color: #1C1C1C;
        }
    </style>
</head>
<body class="bg-dark text-white min-h-screen">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-dark/95 backdrop-blur-sm border-b border-dark-border">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <a id="nav-logo-link" href="index.html" class="flex items-center space-x-2">
                <!-- NEVER CHANGE: Official PowersBioStrikes logo - Google identifier -->
                <img src="images/og-image.png" alt="PowersBioStrikes" class="h-8 w-auto">
            </a>
            <div class="flex items-center space-x-6">
                <a id="nav-home-link" href="index.html" class="text-gray-300 hover:text-gold transition-colors">Home</a>
                <a id="nav-positions-link" href="positions.html" class="text-gray-300 hover:text-gold transition-colors">Positions</a>
                <a href="calendar.html" class="text-gold font-semibold">Calendar</a>
                <a id="nav-members-link" href="login.html" class="px-4 py-2 bg-gold text-dark rounded-lg font-semibold hover:bg-gold/90 transition-colors">Members</a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="pt-24 pb-6 px-4">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-6">
                <h1 class="text-4xl font-bold mb-3">
                    <span class="text-gold">Biotech Catalyst</span> Calendar
                </h1>
                <p id="calendar-description" class="text-gray-400 text-lg max-w-2xl mx-auto">
                    Upcoming PDUFA dates, Phase 2/3 readouts, and AdCom meetings.
                    <span id="member-promo" class="text-gold">Next 7 days free</span><span id="member-promo-suffix"> - full calendar for members.</span>
                </p>
            </div>

            <!-- Summary Stats -->
            <div id="summary-stats" class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-6">
                <!-- Populated by JS -->
            </div>
        </div>
    </section>

    <!-- Calendar Controls -->
    <section class="px-4 pb-4">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                <!-- Month Navigation -->
                <div class="flex items-center gap-4">
                    <button onclick="changeMonth(-1)" class="p-2 rounded-lg bg-dark-card border border-dark-border hover:border-gold transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h2 id="current-month" class="text-2xl font-bold min-w-[200px] text-center">January 2025</h2>
                    <button onclick="changeMonth(1)" class="p-2 rounded-lg bg-dark-card border border-dark-border hover:border-gold transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                    <button onclick="goToToday()" class="px-3 py-2 text-sm rounded-lg bg-dark-card border border-dark-border hover:border-gold transition-colors">
                        Today
                    </button>
                </div>

                <!-- View Toggle & Filters -->
                <div class="flex items-center gap-3">
                    <!-- View Toggle -->
                    <div class="flex rounded-lg overflow-hidden border border-dark-border">
                        <button onclick="setView('grid')" id="view-grid" class="view-toggle-btn active px-3 py-2 text-sm bg-dark-card">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                            </svg>
                        </button>
                        <button onclick="setView('list')" id="view-list" class="view-toggle-btn px-3 py-2 text-sm bg-dark-card">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Filter Dropdown -->
                    <select id="type-filter" onchange="filterCatalysts(this.value)" class="px-3 py-2 rounded-lg bg-dark-card border border-dark-border text-sm focus:border-gold outline-none">
                        <option value="all">All Events</option>
                        <option value="big-movers">Big Movers Only</option>
                        <option value="PDUFA">PDUFA</option>
                        <option value="AdCom">AdCom</option>
                        <option value="Phase 3">Phase 3</option>
                        <option value="Phase 2">Phase 2</option>
                        <option value="Phase 1">Phase 1</option>
                        <option value="Initiation">Initiations</option>
                        <option value="Submission">Submissions</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
        </div>
    </section>

    <!-- Calendar Content -->
    <section class="pb-16 px-4">
        <div class="max-w-7xl mx-auto">
            <!-- Grid View -->
            <div id="calendar-grid-container">
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Header row -->
                    <div class="calendar-header-cell">Sun</div>
                    <div class="calendar-header-cell">Mon</div>
                    <div class="calendar-header-cell">Tue</div>
                    <div class="calendar-header-cell">Wed</div>
                    <div class="calendar-header-cell">Thu</div>
                    <div class="calendar-header-cell">Fri</div>
                    <div class="calendar-header-cell">Sat</div>
                    <!-- Days populated by JS -->
                </div>
            </div>

            <!-- List View (hidden by default) -->
            <div id="list-view-container" class="hidden">
                <div id="list-view" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Members Gate (for non-members viewing beyond 7 days) -->
            <div id="members-gate" class="hidden mt-8 text-center p-8 bg-dark-card border border-gold/30 rounded-xl max-w-md mx-auto">
                <div class="text-4xl mb-4">üîí</div>
                <h3 class="text-xl font-bold text-gold mb-2">Members Only</h3>
                <p class="text-gray-400 mb-4">
                    Get access to the full catalyst calendar with all upcoming events and detailed analysis.
                </p>
                <a href="index.html#founding" class="inline-block px-6 py-3 bg-gold text-dark font-bold rounded-lg hover:bg-gold/90 transition-colors">
                    Become a Founding Member
                </a>
                <p class="text-sm text-gray-500 mt-3">Free for 6 months - limited spots</p>
            </div>
        </div>
    </section>

    <!-- CTA Section (hidden for members) -->
    <section id="cta-section" class="py-16 px-4 bg-dark-card border-t border-dark-border">
        <div class="max-w-4xl mx-auto text-center">
            <h2 class="text-3xl font-bold mb-4">Want the Full Calendar + Trade Alerts?</h2>
            <p class="text-gray-400 mb-6">
                Founding members get 6 months free access to all catalysts, CONT scores, and live trade alerts.
            </p>
            <a href="index.html#founding" class="inline-block px-8 py-4 bg-gold text-dark font-bold rounded-lg text-lg hover:bg-gold/90 transition-colors">
                Join Founding Members
            </a>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-8 px-4 border-t border-dark-border">
        <div class="max-w-7xl mx-auto text-center text-gray-500 text-sm">
            <p>Catalyst dates are sourced from public FDA filings and ClinicalTrials.gov.</p>
            <p class="mt-2">&copy; 2025 PowersBioStrikes. Not financial advice.</p>
        </div>
    </footer>

    <!-- Catalyst Detail Modal -->
    <div id="catalyst-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content p-6" onclick="event.stopPropagation()" style="max-width: 500px;">
            <!-- Header -->
            <div class="flex justify-between items-start mb-4">
                <div>
                    <div class="flex items-center gap-3 mb-1">
                        <span id="modal-ticker" class="text-3xl font-bold"></span>
                        <span id="modal-type-badge" class="type-badge"></span>
                        <span id="modal-big-mover" class="hidden px-2 py-1 text-xs font-bold bg-orange-500/20 text-orange-400 rounded">BIG MOVER</span>
                    </div>
                    <div id="modal-company-name" class="text-gray-500 text-sm"></div>
                    <div id="modal-date" class="text-gray-400 mt-1"></div>
                </div>
                <button onclick="closeModal()" class="text-gray-500 hover:text-white p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4 text-sm">
                <!-- Drug & Indication -->
                <div class="bg-dark-card rounded-lg p-3">
                    <div id="modal-drug" class="text-gold font-semibold"></div>
                    <div id="modal-indication" class="text-gray-400 text-xs mt-1"></div>
                    <div id="modal-category" class="text-gray-500 text-xs mt-1"></div>
                </div>

                <!-- Designations -->
                <div id="modal-designations" class="flex flex-wrap gap-1"></div>

                <!-- Movement Potential (if available) -->
                <div id="modal-movement-section" class="bg-dark-card rounded-lg p-3 hidden">
                    <div class="text-gray-500 text-xs mb-2">MOVEMENT POTENTIAL</div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <div id="modal-success-prob" class="text-lg font-bold text-green-400">-</div>
                            <div class="text-gray-500 text-xs">Success</div>
                        </div>
                        <div>
                            <div id="modal-upside" class="text-lg font-bold text-green-400">-</div>
                            <div class="text-gray-500 text-xs">Upside</div>
                        </div>
                        <div>
                            <div id="modal-downside" class="text-lg font-bold text-red-400">-</div>
                            <div class="text-gray-500 text-xs">Downside</div>
                        </div>
                    </div>
                </div>

                <!-- Risk Assessment -->
                <div class="bg-dark-card rounded-lg p-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-gray-500 text-xs">RISK LEVEL</span>
                            <div class="flex items-center gap-2 mt-1">
                                <span id="modal-risk" class="font-semibold"></span>
                            </div>
                        </div>
                        <div id="modal-crl-warning" class="hidden text-right">
                            <span class="text-red-400 text-xs font-bold">CRL HISTORY</span>
                            <div id="modal-crl-count" class="text-red-400 text-xs"></div>
                        </div>
                    </div>
                    <div id="modal-risk-note" class="text-xs text-gray-500 mt-1"></div>
                </div>

                <!-- Company Stats -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-dark-card rounded-lg p-3 text-center">
                        <div id="modal-mcap" class="text-lg font-bold text-white">-</div>
                        <div class="text-gray-500 text-xs">Market Cap</div>
                    </div>
                    <div class="bg-dark-card rounded-lg p-3 text-center">
                        <div id="modal-short" class="text-lg font-bold text-white">-</div>
                        <div class="text-gray-500 text-xs">Short Interest</div>
                    </div>
                </div>

                <!-- Members-Only Analysis Section -->
                <div id="modal-analysis-section" class="bg-gradient-to-r from-gold/10 to-transparent rounded-lg p-3 hidden">
                    <div class="text-gold text-xs mb-2 font-semibold">MEMBERS ANALYSIS</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <span class="text-gray-500 text-xs">CONT Score</span>
                            <div id="modal-cont-score" class="font-bold text-white">-</div>
                        </div>
                        <div>
                            <span class="text-gray-500 text-xs">Play Type</span>
                            <div id="modal-play-type" class="font-bold text-white">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK for auth check -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        let calendarData = null;
        let currentFilter = 'all';
        let currentView = 'grid';
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let isUserAuthenticated = false;

        // Update navigation for logged-in members
        async function updateNavForMember() {
            try {
                const user = await pbsAuth.getUser();
                if (user) {
                    const logoLink = document.getElementById('nav-logo-link');
                    if (logoLink) logoLink.href = 'dashboard.html';

                    const homeLink = document.getElementById('nav-home-link');
                    if (homeLink) {
                        homeLink.href = 'dashboard.html';
                        homeLink.textContent = '‚Üê Dashboard';
                    }

                    const positionsLink = document.getElementById('nav-positions-link');
                    if (positionsLink) positionsLink.classList.add('hidden');

                    const membersLink = document.getElementById('nav-members-link');
                    if (membersLink) membersLink.classList.add('hidden');
                }
            } catch (err) {}
        }

        document.addEventListener('DOMContentLoaded', updateNavForMember);

        // Check authentication
        async function checkAuth() {
            try {
                const user = await pbsAuth.getUser();
                isUserAuthenticated = !!user;

                if (isUserAuthenticated) {
                    // Hide non-member promotional elements
                    document.getElementById('member-promo')?.classList.add('hidden');
                    document.getElementById('member-promo-suffix')?.classList.add('hidden');
                    document.getElementById('cta-section')?.classList.add('hidden');
                    document.getElementById('members-gate')?.classList.add('hidden');
                }
            } catch (e) {
                isUserAuthenticated = false;
            }
        }

        // Load calendar data
        async function loadCalendar() {
            try {
                const response = await fetch('data/calendar.json');
                calendarData = await response.json();
                renderSummary();
                renderCalendar();
            } catch (error) {
                console.error('Failed to load calendar:', error);
            }
        }

        // Render summary stats
        function renderSummary() {
            const summary = calendarData.summary;
            document.getElementById('summary-stats').innerHTML = `
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-gold">${summary.total_catalysts}</div>
                    <div class="text-gray-500 text-xs">Total</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-400">${summary.this_week}</div>
                    <div class="text-gray-500 text-xs">This Week</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-red-400">${summary.by_type.PDUFA || 0}</div>
                    <div class="text-gray-500 text-xs">PDUFA</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-orange-400">${summary.by_type['Phase 3'] || 0}</div>
                    <div class="text-gray-500 text-xs">Phase 3</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-blue-400">${summary.by_type['Phase 2'] || 0}</div>
                    <div class="text-gray-500 text-xs">Phase 2</div>
                </div>
                <div class="bg-dark-card border border-dark-border rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold" style="color: #4CAF50">${summary.by_type['Phase 1'] || 0}</div>
                    <div class="text-gray-500 text-xs">Phase 1</div>
                </div>
            `;
        }

        // Get catalysts for a specific date
        function getCatalystsForDate(year, month, day) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            return calendarData.catalysts.filter(c => {
                if (currentFilter === 'big-movers' && !c.movement?.is_big_mover) return false;
                if (currentFilter !== 'all' && currentFilter !== 'big-movers' && c.event.type !== currentFilter) return false;
                return c.date === dateStr;
            });
        }

        // Check if date is within free preview period (7 days)
        function isWithinFreePreview(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(dateStr);
            const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            return diffDays <= 7 && diffDays >= 0;
        }

        // Get type class for chip
        function getTypeClass(type) {
            const typeMap = {
                'PDUFA': 'pdufa',
                'Phase 3': 'phase3',
                'Phase 2': 'phase2',
                'Phase 1': 'phase1',
                'AdCom': 'adcom',
                'Initiation': 'initiation',
                'Submission': 'submission'
            };
            return typeMap[type] || 'other';
        }

        // Check if a date is in the current week
        function isInCurrentWeek(year, month, day) {
            const today = new Date();
            const checkDate = new Date(year, month, day);

            // Get start of current week (Sunday)
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            weekStart.setHours(0, 0, 0, 0);

            // Get end of current week (Saturday)
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);

            return checkDate >= weekStart && checkDate <= weekEnd;
        }

        // Get day of week (0=Sunday, 6=Saturday)
        function getDayOfWeek(year, month, day) {
            return new Date(year, month, day).getDay();
        }

        // Render calendar grid
        function renderCalendar() {
            if (currentView === 'grid') {
                renderGridView();
            } else {
                renderListView();
            }
        }

        // Render grid view
        function renderGridView() {
            document.getElementById('calendar-grid-container').classList.remove('hidden');
            document.getElementById('list-view-container').classList.add('hidden');

            // Update month title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Get first day of month and total days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

            const today = new Date();
            const isCurrentMonth = today.getFullYear() === currentYear && today.getMonth() === currentMonth;

            // Build calendar grid
            const grid = document.getElementById('calendar-grid');

            // Keep header cells, remove day cells
            const headerCells = Array.from(grid.querySelectorAll('.calendar-header-cell'));
            grid.innerHTML = '';
            headerCells.forEach(cell => grid.appendChild(cell));

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                grid.appendChild(createDayCell(prevYear, prevMonth, day, true));
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = isCurrentMonth && today.getDate() === day;
                grid.appendChild(createDayCell(currentYear, currentMonth, day, false, isToday));
            }

            // Next month days to complete the grid
            const totalCells = firstDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let day = 1; day <= remainingCells; day++) {
                const nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
                const nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;
                grid.appendChild(createDayCell(nextYear, nextMonth, day, true));
            }
        }

        // Create a day cell
        function createDayCell(year, month, day, isOtherMonth, isToday = false) {
            const cell = document.createElement('div');
            let className = 'calendar-day';
            if (isOtherMonth) className += ' other-month';
            if (isToday) className += ' today';

            // Add current week highlighting
            if (!isOtherMonth && isInCurrentWeek(year, month, day)) {
                className += ' current-week';
                const dayOfWeek = getDayOfWeek(year, month, day);
                if (dayOfWeek === 0) className += ' week-start';
                if (dayOfWeek === 6) className += ' week-end';
            }

            cell.className = className;

            const dayNum = document.createElement('div');
            dayNum.className = 'day-number';
            dayNum.textContent = day;
            cell.appendChild(dayNum);

            // Get catalysts for this day
            const catalysts = getCatalystsForDate(year, month, day);
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isPreview = isWithinFreePreview(dateStr);
            const canView = isUserAuthenticated || isPreview;

            // Show up to 3 catalysts, then "more" link
            const maxShow = 3;
            catalysts.slice(0, maxShow).forEach(cat => {
                const chip = document.createElement('div');
                const isBigMover = cat.movement?.is_big_mover;
                chip.className = `catalyst-chip ${getTypeClass(cat.event.type)}${isBigMover ? ' big-mover' : ''}` + (!canView ? ' blur-content' : '');
                const typeAbbr = {'Phase 3': 'P3', 'Phase 2': 'P2', 'Phase 1': 'P1', 'Initiation': 'INIT', 'Submission': 'SUB'}[cat.event.type] || cat.event.type;
                chip.innerHTML = `
                    ${isBigMover ? '<span style="color: #FFA500;">‚òÖ</span>' : ''}
                    <span class="ticker">${cat.ticker}</span>
                    <span class="type-abbr">${typeAbbr}</span>
                `;
                if (canView) {
                    chip.onclick = () => openModal(cat);
                }
                cell.appendChild(chip);
            });

            if (catalysts.length > maxShow) {
                const more = document.createElement('div');
                more.className = 'more-catalysts' + (!canView ? ' blur-content' : '');
                more.textContent = `+${catalysts.length - maxShow} more`;
                if (canView) {
                    more.onclick = () => showDayModal(year, month, day, catalysts);
                }
                cell.appendChild(more);
            }

            return cell;
        }

        // Render list view
        function renderListView() {
            document.getElementById('calendar-grid-container').classList.add('hidden');
            document.getElementById('list-view-container').classList.remove('hidden');

            const listView = document.getElementById('list-view');

            // Filter catalysts for current month
            const catalysts = calendarData.catalysts.filter(c => {
                if (currentFilter === 'big-movers' && !c.movement?.is_big_mover) return false;
                if (currentFilter !== 'all' && currentFilter !== 'big-movers' && c.event.type !== currentFilter) return false;
                const date = new Date(c.date);
                return date.getFullYear() === currentYear && date.getMonth() === currentMonth;
            });

            if (catalysts.length === 0) {
                listView.innerHTML = '<p class="text-gray-500 text-center py-8">No catalysts this month.</p>';
                return;
            }

            listView.innerHTML = catalysts.map(cat => {
                const canView = isUserAuthenticated || isWithinFreePreview(cat.date);
                const typeClass = `type-${cat.event.type.toLowerCase().replace(' ', '')}`;
                const riskClass = `risk-${cat.risk.level.toLowerCase().replace('-', '')}`;

                const designationBadges = cat.designations.map(d =>
                    `<span class="designation-badge" style="background: ${d.color}20; color: ${d.color}; border: 1px solid ${d.color}40">${d.code}</span>`
                ).join('');

                return `
                    <div class="list-view-card rounded-lg p-4 ${!canView ? 'blur-content' : ''}" ${canView ? `onclick="openModal(calendarData.catalysts.find(c => c.ticker === '${cat.ticker}' && c.date === '${cat.date}'))"` : ''} style="cursor: ${canView ? 'pointer' : 'default'}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-3">
                                <span class="text-xl font-bold">${cat.ticker}</span>
                                <span class="type-badge ${typeClass}">${cat.event.type}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold">${cat.date_display}</div>
                                <div class="text-gray-500 text-sm">${cat.weekday}</div>
                            </div>
                        </div>
                        <div class="text-gold text-sm">${cat.event.drug_name || ''}</div>
                        <div class="text-gray-500 text-sm">${cat.event.indication || cat.event.description || ''}</div>
                        ${designationBadges ? `<div class="flex flex-wrap gap-1 mt-2">${designationBadges}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Open modal with catalyst details
        function openModal(catalyst) {
            const modal = document.getElementById('catalyst-modal');
            const typeClass = `type-${catalyst.event.type.toLowerCase().replace(' ', '')}`;
            const riskClass = `risk-${catalyst.risk.level.toLowerCase().replace('-', '')}`;

            // Header
            document.getElementById('modal-ticker').textContent = catalyst.ticker;
            document.getElementById('modal-type-badge').className = `type-badge ${typeClass}`;
            document.getElementById('modal-type-badge').textContent = catalyst.event.type;
            document.getElementById('modal-date').textContent = `${catalyst.date_display} (${catalyst.weekday}) ‚Ä¢ ${catalyst.days_until} days`;
            document.getElementById('modal-company-name').textContent = catalyst.company?.name || '';

            // Big mover badge
            const bigMoverBadge = document.getElementById('modal-big-mover');
            if (catalyst.movement?.is_big_mover) {
                bigMoverBadge.classList.remove('hidden');
            } else {
                bigMoverBadge.classList.add('hidden');
            }

            // Drug & Indication
            document.getElementById('modal-drug').textContent = catalyst.event.drug_name || 'Drug name not available';
            document.getElementById('modal-indication').textContent = catalyst.event.indication || '';
            document.getElementById('modal-category').textContent = catalyst.event.category ? `Category: ${catalyst.event.category}` : '';

            // Designations
            const designationsHtml = catalyst.designations.map(d =>
                `<span class="px-2 py-0.5 text-xs rounded" style="background: ${d.color}20; color: ${d.color}; border: 1px solid ${d.color}40">${d.code}</span>`
            ).join('');
            document.getElementById('modal-designations').innerHTML = designationsHtml;

            // Movement Potential
            const movementSection = document.getElementById('modal-movement-section');
            if (catalyst.movement?.success_prob || catalyst.movement?.upside_pct) {
                movementSection.classList.remove('hidden');
                document.getElementById('modal-success-prob').textContent = catalyst.movement.success_prob
                    ? `${catalyst.movement.success_prob.toFixed(0)}%` : '-';
                document.getElementById('modal-upside').textContent = catalyst.movement.upside_pct
                    ? `+${catalyst.movement.upside_pct.toFixed(0)}%` : '-';
                document.getElementById('modal-downside').textContent = catalyst.movement.downside_pct
                    ? `-${catalyst.movement.downside_pct.toFixed(0)}%` : '-';
            } else {
                movementSection.classList.add('hidden');
            }

            // Risk
            document.getElementById('modal-risk').textContent = catalyst.risk.level;
            document.getElementById('modal-risk').className = riskClass + ' font-semibold';
            document.getElementById('modal-risk-note').textContent = catalyst.risk.note;

            // CRL Warning
            const crlWarning = document.getElementById('modal-crl-warning');
            if (catalyst.risk_factors?.has_crl_history) {
                crlWarning.classList.remove('hidden');
                document.getElementById('modal-crl-count').textContent = `${catalyst.risk_factors.crl_count} prior rejection(s)`;
            } else {
                crlWarning.classList.add('hidden');
            }

            // Company info
            document.getElementById('modal-mcap').textContent = catalyst.company.mcap_millions
                ? `$${catalyst.company.mcap_millions.toFixed(0)}M` : '-';
            document.getElementById('modal-short').textContent = catalyst.company.short_interest_pct
                ? `${catalyst.company.short_interest_pct.toFixed(1)}%` : '-';

            // Members-only analysis (only show if logged in and data available)
            const analysisSection = document.getElementById('modal-analysis-section');
            if (isUserAuthenticated && (catalyst.analysis?.cont_score || catalyst.analysis?.play_type)) {
                analysisSection.classList.remove('hidden');
                document.getElementById('modal-cont-score').textContent = catalyst.analysis.cont_score
                    ? `${catalyst.analysis.cont_score}` : '-';
                document.getElementById('modal-play-type').textContent = catalyst.analysis.play_type || '-';
            } else {
                analysisSection.classList.add('hidden');
            }

            modal.classList.add('active');
        }

        // Close modal
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('catalyst-modal').classList.remove('active');
        }

        // Show all catalysts for a day (when clicking "+more")
        function showDayModal(year, month, day, catalysts) {
            // For simplicity, just open the first one
            // Could be enhanced to show a list
            openModal(catalysts[0]);
        }

        // Change month
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        // Go to today
        function goToToday() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            renderCalendar();
        }

        // Set view (grid/list)
        function setView(view) {
            currentView = view;
            document.getElementById('view-grid').classList.toggle('active', view === 'grid');
            document.getElementById('view-list').classList.toggle('active', view === 'list');
            renderCalendar();
        }

        // Filter catalysts
        function filterCatalysts(filter) {
            currentFilter = filter;
            document.getElementById('type-filter').value = filter;
            renderCalendar();
        }

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Initialize
        async function init() {
            await checkAuth();
            await loadCalendar();
        }
        init();
    </script>
</body>
</html>
